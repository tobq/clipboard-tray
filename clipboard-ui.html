<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Clipboard</title>
<style>
  :root { --bg: #0c0c0c; --surface: #131313; --surface2: #1a1a1a; --text: #ccc; --text-dim: #555;
          --accent: #a78bfa; --green: #34d399; --red: #f87171; --pin: #f59e0b; }
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; overflow:hidden; }
  body { font-family:'Segoe UI',system-ui,sans-serif; background:var(--surface); color:var(--text); display:flex; flex-direction:column; }
  ::-webkit-scrollbar { width:0; }

  .sticky { flex-shrink:0; background:var(--surface); padding-bottom:4px; z-index:10; position:relative; }
  header { display:flex; align-items:center; padding:10px 14px 0; gap:6px; }
  .count { font-size:11px; color:var(--text-dim); flex:1; }
  .hdr-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:11px; padding:4px 8px; transition:color .15s; }
  .hdr-btn:hover { color:var(--red); }
  .hdr-btn.gear { font-size:14px; }
  .hdr-btn.gear:hover { color:var(--accent); }
  .search-row { display:flex; align-items:center; margin:8px 14px 4px; gap:4px; }
  .search { flex:1; background:#0a0a0a; border:1px solid #222; border-radius:6px; padding:7px 10px; color:var(--text); font-size:13px; outline:none; font-family:inherit; }
  .search:focus { border-color:var(--accent); }
  .search::placeholder { color:var(--text-dim); }
  .rx-btn { background:#0a0a0a; border:1px solid #222; border-radius:4px; padding:4px 7px; color:var(--text-dim); cursor:pointer; font-family:'Cascadia Code',monospace; font-size:12px; transition:all .15s; }
  .rx-btn.active { color:var(--accent); border-color:var(--accent); }

  .main-view { display:flex; flex-direction:column; flex:1; min-height:0; }
  .list { flex:1; overflow-y:auto; padding:0 0 8px; min-height:0; }
  .item { padding:8px 14px; cursor:pointer; transition:background .1s; position:relative; border-bottom:1px solid #111; }
  .item:hover, .item.selected { background:var(--surface2); }
  .item.has-pin { border-left:2px solid var(--pin); }

  .item-row { display:flex; align-items:flex-start; gap:8px; }
  .pin-area { position:relative; flex-shrink:0; display:flex; align-items:center; gap:2px; padding-top:2px; }
  .star { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:14px; padding:2px; transition:color .15s; line-height:1; }
  .star.active { color:var(--pin); }
  .star:hover { color:var(--pin); }
  .numpad-badge { color:var(--green); font-size:11px; font-weight:600; min-width:14px; text-align:center; }

  .numpad-picker { display:none; position:absolute; top:100%; left:-4px; z-index:20; background:#0a0a0a; border:1px solid #333; border-radius:6px;
                   padding:3px; gap:2px; flex-wrap:nowrap; white-space:nowrap; box-shadow:0 4px 12px rgba(0,0,0,.5); }
  .pin-area:hover .numpad-picker { display:flex; }
  .np-btn { width:22px; height:22px; display:flex; align-items:center; justify-content:center; border-radius:3px; font-size:11px;
            font-family:'Cascadia Code',monospace; cursor:pointer; transition:all .1s; }
  .np-btn.free { color:var(--accent); background:transparent; }
  .np-btn.taken { color:var(--text-dim); background:transparent; }
  .np-btn.current { color:var(--green); background:#0f2a1f; }
  .np-btn:hover { background:#252525; color:#fff; }

  .content { flex:1; min-width:0; }
  .preview { font-size:12px; line-height:1.5; color:var(--text); font-family:'Cascadia Code','Consolas',monospace; }
  .preview.collapsed { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .preview.expanded { white-space:pre-wrap; word-break:break-word; max-height:300px; overflow-y:auto; background:var(--bg); border-radius:6px; padding:8px; margin:2px 0; }
  .preview img { max-width:100%; max-height:60px; border-radius:4px; }
  .meta { margin-top:3px; font-size:10px; color:var(--text-dim); display:flex; gap:8px; }

  .actions { display:flex; align-items:center; gap:1px; flex-shrink:0; opacity:0; transition:opacity .1s; }
  .item:hover .actions { opacity:1; }
  .act { background:none; border:none; color:var(--text-dim); cursor:pointer; padding:3px 4px; font-size:11px; border-radius:3px; transition:all .1s; line-height:1; }
  .act:hover { color:var(--red); background:#ffffff08; }

  mark { background:rgba(167,139,250,.2); color:#c4b5fd; border-radius:2px; padding:0 1px; }
  .toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(16px); background:var(--green); color:#000;
           padding:6px 16px; border-radius:16px; font-size:12px; font-weight:500; opacity:0; transition:all .2s; pointer-events:none; z-index:50; }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  .empty { text-align:center; color:var(--text-dim); padding:60px 0; font-size:13px; }

  /* Confirm dialog */
  .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:30; align-items:center; justify-content:center; }
  .overlay.show { display:flex; }
  .dialog { background:var(--surface); border:1px solid #333; border-radius:10px; padding:16px 20px; max-width:320px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,.5); }
  .dialog h3 { font-size:13px; font-weight:500; margin-bottom:6px; }
  .dialog p { font-size:11px; color:var(--text-dim); margin-bottom:12px; font-family:'Cascadia Code',monospace; word-break:break-word; }
  .dialog-btns { display:flex; gap:8px; justify-content:flex-end; }
  .dialog-btns button { border:none; border-radius:6px; padding:6px 16px; cursor:pointer; font-size:12px; transition:all .15s; }
  .btn-confirm { background:var(--green); color:#000; }
  .btn-confirm:hover { filter:brightness(1.1); }
  .btn-cancel { background:#222; color:var(--text-dim); }
  .btn-cancel:hover { background:#333; color:var(--text); }

  /* Settings view */
  .settings-view { display:none; flex-direction:column; height:100%; }
  .settings-view.show { display:flex; }
  .main-view.hidden { display:none; }
  .settings-hdr { display:flex; align-items:center; padding:12px 14px; gap:10px; border-bottom:1px solid #222; }
  .settings-hdr .back { background:none; border:none; color:var(--accent); cursor:pointer; font-size:13px; padding:4px 8px; }
  .settings-hdr .back:hover { color:#fff; }
  .settings-hdr h2 { font-size:14px; font-weight:500; flex:1; }
  .settings-body { flex:1; overflow-y:auto; padding:12px 14px; }
  .setting-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0; }
  .setting-row label { font-size:12px; color:var(--text); }
  .setting-row input { width:80px; background:#0a0a0a; border:1px solid #222; border-radius:4px; padding:5px 8px; color:var(--text); font-size:12px; text-align:right; outline:none; }
  .setting-row input:focus { border-color:var(--accent); }
  .settings-section { margin-top:16px; }
  .settings-section h3 { font-size:12px; color:var(--text-dim); margin-bottom:8px; text-transform:uppercase; letter-spacing:.5px; }
  .np-slot { display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #111; }
  .np-slot .np-num { color:var(--accent); font-family:'Cascadia Code',monospace; font-size:13px; font-weight:600; min-width:18px; }
  .np-slot .np-text { flex:1; font-size:11px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-family:'Cascadia Code',monospace; }
  .np-slot .np-text.empty { font-style:italic; }
  .np-slot .np-remove { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:11px; padding:2px 6px; border-radius:3px; }
  .np-slot .np-remove:hover { color:var(--red); background:#ffffff08; }
  .settings-usage { font-size:11px; color:var(--text-dim); margin-top:12px; }
  .settings-footer { position:sticky; bottom:0; padding:12px 0 8px; background:rgba(19,19,19,.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
  .settings-save { border:none; background:var(--green); color:#000; padding:8px 24px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:500; width:100%; }
  .settings-save:hover { filter:brightness(1.1); }
</style></head><body>

<div class="main-view" id="mainView">
  <div class="sticky">
    <header>
      <span class="count" id="count"></span>
      <button class="hdr-btn gear" id="settingsBtn" title="Settings">&#9881;</button>
      <button class="hdr-btn" id="deleteAll">Clear</button>
    </header>
    <div class="search-row">
      <input class="search" id="search" type="text" placeholder="Search..." autocomplete="off" spellcheck="false">
      <button class="rx-btn" id="regexBtn" title="Regex search">.*</button>
    </div>
  </div>
  <div class="list" id="list"></div>
</div>

<div class="settings-view" id="settingsView">
  <div class="settings-hdr">
    <button class="back" id="settingsBack">&larr; Back</button>
    <h2>Settings</h2>
  </div>
  <div class="settings-body">
    <div class="setting-row"><label>Max age (days)</label><input id="maxAge" type="number" min="1"></div>
    <div class="setting-row"><label>Max size (GB)</label><input id="maxSize" type="number" min="0.1" step="0.1"></div>
    <div class="settings-usage" id="usage"></div>
    <div class="settings-section">
      <h3>Numpad Shortcuts</h3>
      <div id="numpadSlots"></div>
    </div>
    <div class="settings-footer">
      <button class="settings-save" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<div class="overlay" id="confirmOverlay">
  <div class="dialog">
    <h3 id="confirmTitle"></h3>
    <p id="confirmMsg"></p>
    <div class="dialog-btns">
      <button class="btn-cancel" id="confirmNo">Cancel</button>
      <button class="btn-confirm" id="confirmYes">Replace</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copied</div>

<script>
const BADGES = {1:'\u2460',2:'\u2461',3:'\u2462',4:'\u2463',5:'\u2464',6:'\u2465',7:'\u2466',8:'\u2467',9:'\u2468'};
const listEl = document.getElementById('list');
const toast = document.getElementById('toast');
const searchEl = document.getElementById('search');
const countEl = document.getElementById('count');
const regexBtn = document.getElementById('regexBtn');
let toastTimer, items = [], expanded = new Set(), query = '', regexOn = false, selectedIdx = -1;
const BATCH = 30;
let rendered = 0, filtered = [];

// --- Helpers ---
function ago(ts) {
  const s = Math.floor(Date.now()/1000 - ts);
  if (s < 3) return 'now'; if (s < 60) return s+'s'; if (s < 3600) return Math.floor(s/60)+'m';
  if (s < 86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d';
}
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function highlight(text, q) {
  if (!q) return esc(text);
  try {
    const re = regexOn ? new RegExp('('+q+')', 'gi') : new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')+')', 'gi');
    return esc(text).replace(re, '<mark>$1</mark>');
  } catch { return esc(text); }
}
function matches(text, q) {
  if (!q) return true;
  try {
    return regexOn ? new RegExp(q, 'i').test(text) : text.toLowerCase().includes(q.toLowerCase());
  } catch { return false; }
}
function isPinned(item) { return !!item.pinned; }
function numpadOf(item) { const p = item.pinned; return typeof p === 'number' && p >= 1 && p <= 9 ? p : null; }
function showToast(msg) { toast.textContent = msg||'Copied'; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(()=>toast.classList.remove('show'),1200); }
const post = (url, body) => fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});

// --- Numpad slot map ---
function numpadMap() {
  const m = {};
  items.forEach((it,i) => { const n = numpadOf(it); if (n) m[n] = i; });
  return m;
}

// --- Rendering ---
function applyFilter() {
  const q = query;
  filtered = [];
  items.forEach((it, i) => {
    const text = it.type === 'image' ? 'image' : (it.text || '');
    if (matches(text, q)) filtered.push(i);
  });
  rendered = 0;
  listEl.innerHTML = '';
  selectedIdx = -1;
  loadBatch();
  if (!filtered.length) listEl.innerHTML = `<div class="empty">${q ? 'No matches' : 'Copy something to get started'}</div>`;
}

function loadBatch() {
  const end = Math.min(rendered + BATCH, filtered.length);
  const nmap = numpadMap();
  const frag = document.createDocumentFragment();
  for (let fi = rendered; fi < end; fi++) {
    const ri = filtered[fi];
    const it = items[ri];
    frag.appendChild(buildItem(it, ri, nmap));
  }
  listEl.appendChild(frag);
  rendered = end;
}

function buildItem(it, ri, nmap) {
  const pinned = isPinned(it);
  const np = numpadOf(it);
  const isImage = it.type === 'image';
  const el = document.createElement('div');
  el.className = 'item' + (pinned ? ' has-pin' : '');
  el.dataset.i = ri;
  el.dataset.fi = '';

  let previewHtml;
  let metaHtml;
  if (isImage) {
    previewHtml = `<img src="/images/${esc(it.image)}" alt="image">`;
    metaHtml = `<span>${ago(it.ts)}</span><span>${it.width||'?'}x${it.height||'?'}</span>`;
  } else {
    const text = it.text || '';
    const exp = expanded.has(ri);
    const display = exp ? text : text.replace(/\r?\n/g, ' ');
    const canExp = text.length > 120 || (text.match(/\n/g)||[]).length > 0;
    previewHtml = highlight(display, query);
    metaHtml = `<span>${ago(it.ts)}</span><span>${text.length.toLocaleString()} chars</span>`;
    if (canExp) {
      metaHtml += `<span class="expand-toggle" style="color:var(--accent);cursor:pointer">${exp?'collapse':'expand'}</span>`;
    }
  }
  if (pinned) metaHtml += `<span style="color:var(--pin)">pinned</span>`;

  // Build numpad picker buttons
  let npBtns = '';
  for (let n = 1; n <= 9; n++) {
    const cls = np === n ? 'current' : (n in nmap ? 'taken' : 'free');
    npBtns += `<span class="np-btn ${cls}" data-n="${n}">${n}</span>`;
  }

  el.innerHTML = `<div class="item-row">
    <div class="pin-area">
      <button class="star${pinned?' active':''}" data-action="pin" data-i="${ri}" title="${pinned?'Unpin':'Pin'}">&#9733;</button>
      ${np ? `<span class="numpad-badge">${BADGES[np]}</span>` : ''}
      <div class="numpad-picker">${npBtns}</div>
    </div>
    <div class="content">
      <div class="preview ${expanded.has(ri)?'expanded':'collapsed'}">${previewHtml}</div>
      <div class="meta">${metaHtml}</div>
    </div>
    <div class="actions"><button class="act" data-action="del" data-i="${ri}" title="Delete">&#10005;</button></div>
  </div>`;
  return el;
}

function updateCount() {
  countEl.textContent = filtered.length + ' item' + (filtered.length !== 1 ? 's' : '');
}

// --- Scroll-based lazy load ---
listEl.addEventListener('scroll', () => {
  if (rendered < filtered.length) {
    const {scrollTop, scrollHeight, clientHeight} = listEl;
    if (scrollTop + clientHeight > scrollHeight * 0.85) loadBatch();
  }
});

// --- Event delegation ---
document.addEventListener('click', e => {
  // Numpad picker
  const npBtn = e.target.closest('.np-btn');
  if (npBtn) {
    e.stopPropagation();
    const n = +npBtn.dataset.n;
    const item = npBtn.closest('.item');
    if (!item) return;
    const ri = +item.dataset.i;
    tryAssignNumpad(n, ri);
    return;
  }
  // Star/pin
  const star = e.target.closest('[data-action="pin"]');
  if (star) { e.stopPropagation(); post('/api/pin', {index:+star.dataset.i}).then(refresh); return; }
  // Delete
  const del = e.target.closest('[data-action="del"]');
  if (del) { e.stopPropagation(); post('/api/delete', {index:+del.dataset.i}).then(refresh); return; }
  // Expand toggle
  const exp = e.target.closest('.expand-toggle');
  if (exp) { e.stopPropagation(); const item = exp.closest('.item'); if(item){ const ri=+item.dataset.i; expanded.has(ri)?expanded.delete(ri):expanded.add(ri); applyFilter(); } return; }
  // Click item to paste
  const item = e.target.closest('.item');
  if (item) {
    const idx = +item.dataset.i;
    if (window.pywebview) { pywebview.api.paste_and_hide(idx); }
    else { post('/api/paste', {index:idx}); }
    return;
  }
});

// --- Numpad assign with confirm ---
let pendingAssign = null;
function tryAssignNumpad(slot, itemIdx) {
  const nmap = numpadMap();
  if (slot in nmap && nmap[slot] !== itemIdx) {
    const existing = items[nmap[slot]];
    const preview = existing.type === 'image' ? '[image]' : (existing.text||'').slice(0,80);
    document.getElementById('confirmTitle').textContent = `Numpad ${slot} already assigned:`;
    document.getElementById('confirmMsg').textContent = preview;
    pendingAssign = {slot, itemIdx};
    document.getElementById('confirmOverlay').classList.add('show');
  } else {
    post('/api/numpad-assign', {index:itemIdx, slot}).then(refresh);
  }
}
document.getElementById('confirmYes').addEventListener('click', () => {
  if (pendingAssign) { post('/api/numpad-assign', {index:pendingAssign.itemIdx, slot:pendingAssign.slot}).then(refresh); }
  pendingAssign = null;
  document.getElementById('confirmOverlay').classList.remove('show');
});
document.getElementById('confirmNo').addEventListener('click', () => {
  pendingAssign = null;
  document.getElementById('confirmOverlay').classList.remove('show');
});

// Global function called from Python keyboard hook
window.assignNumpad = function(slot) {
  if (selectedIdx >= 0 && selectedIdx < filtered.length) {
    tryAssignNumpad(slot, filtered[selectedIdx]);
  }
};

// --- Clear all ---
document.getElementById('deleteAll').addEventListener('click', () => post('/api/delete-all', {}).then(refresh));

// --- Search ---
searchEl.addEventListener('input', e => { query = e.target.value; applyFilter(); updateCount(); });

// --- Regex toggle ---
regexBtn.addEventListener('click', () => {
  regexOn = !regexOn;
  regexBtn.classList.toggle('active', regexOn);
  post('/api/settings', {regex_search: regexOn});
  applyFilter();
});

// --- Keyboard nav ---
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('confirmOverlay').classList.contains('show')) {
      document.getElementById('confirmOverlay').classList.remove('show');
      pendingAssign = null;
    } else if (document.getElementById('settingsView').classList.contains('show')) {
      closeSettings();
    } else if (window.pywebview) {
      pywebview.api.hide_popup();
    }
    return;
  }
  if (document.getElementById('settingsView').classList.contains('show')) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); moveSelection(1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); moveSelection(-1); }
  else if (e.key === 'Enter' && selectedIdx >= 0 && selectedIdx < filtered.length) {
    e.preventDefault();
    const idx = filtered[selectedIdx];
    if (window.pywebview) { pywebview.api.paste_and_hide(idx); }
    else { post('/api/paste', {index:idx}); }
  }
});

function moveSelection(dir) {
  const items_els = listEl.querySelectorAll('.item');
  if (!items_els.length) return;
  const newIdx = Math.max(0, Math.min(selectedIdx + dir, filtered.length - 1));
  if (newIdx >= rendered) loadBatch();
  selectedIdx = newIdx;
  items_els.forEach((el, i) => el.classList.toggle('selected', i === selectedIdx));
  const sel = items_els[selectedIdx];
  if (sel) sel.scrollIntoView({block:'nearest'});
}

// --- Settings ---
document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('settingsBack').addEventListener('click', closeSettings);
document.getElementById('settingsSave').addEventListener('click', saveSettings);

async function openSettings() {
  const r = await fetch('/api/settings'); const s = await r.json();
  document.getElementById('maxAge').value = s.max_age_days;
  document.getElementById('maxSize').value = s.max_size_gb;
  regexOn = s.regex_search || false;
  regexBtn.classList.toggle('active', regexOn);
  const bytes = s.storage_bytes || 0;
  const mb = (bytes / 1048576).toFixed(1);
  document.getElementById('usage').textContent = `Current: ${s.item_count} items, ${mb} MB`;

  // Numpad slots
  const slotsEl = document.getElementById('numpadSlots');
  const nmap = numpadMap();
  slotsEl.innerHTML = '';
  for (let n = 1; n <= 9; n++) {
    const has = n in nmap;
    const it = has ? items[nmap[n]] : null;
    const text = it ? (it.type === 'image' ? '[image]' : (it.text||'').replace(/\n/g,' ').slice(0,60)) : '';
    slotsEl.innerHTML += `<div class="np-slot">
      <span class="np-num">${n}</span>
      <span class="np-text${has?'':' empty'}">${has ? esc(text) : 'empty'}</span>
      ${has ? `<button class="np-remove" data-slot="${n}" title="Unassign">&times;</button>` : ''}
    </div>`;
  }
  slotsEl.querySelectorAll('.np-remove').forEach(btn => {
    btn.addEventListener('click', async () => {
      await post('/api/numpad-unassign', {slot: +btn.dataset.slot});
      await refresh();
      openSettings(); // refresh settings view
    });
  });

  document.getElementById('mainView').classList.add('hidden');
  document.getElementById('settingsView').classList.add('show');
}

function closeSettings() {
  document.getElementById('settingsView').classList.remove('show');
  document.getElementById('mainView').classList.remove('hidden');
  searchEl.focus();
}

async function saveSettings() {
  const age = parseInt(document.getElementById('maxAge').value) || 7;
  const size = parseFloat(document.getElementById('maxSize').value) || 10;
  await post('/api/settings', {max_age_days: age, max_size_gb: size});
  closeSettings();
  refresh();
}

// --- Data refresh ---
async function refresh() {
  try {
    const r = await fetch('/api/history');
    const data = await r.json();
    if (JSON.stringify(data) !== JSON.stringify(items)) {
      items = data;
      applyFilter();
      updateCount();
    }
  } catch {}
}

// Initial load + poll
refresh();
setInterval(refresh, 1000);

// --- pywebview integration ---
let shownAt = 0;
window.addEventListener('focus', () => {
  shownAt = Date.now();
  refresh();
  setTimeout(() => searchEl.focus(), 50);
});
window.addEventListener('blur', () => {
  if (window.pywebview && Date.now() - shownAt > 400) {
    setTimeout(() => { try { pywebview.api.hide_popup(); } catch{} }, 80);
  }
});
</script></body></html>
